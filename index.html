from fastapi import FastAPI, HTTPException, UploadFile, File, Path
from pydantic import BaseModel
import subprocess
import requests
from datetime import datetime
import os
import shutil
import logging
from fastapi.middleware.cors import CORSMiddleware
from fastapi.responses import FileResponse

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è FastAPI
app = FastAPI()

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CORS
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –¥–æ–º–µ–Ω—ã
    allow_credentials=True,
    allow_methods=["*"],  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –º–µ—Ç–æ–¥—ã (GET, POST, OPTIONS –∏ —Ç.–¥.)
    allow_headers=["*"],  # –†–∞–∑—Ä–µ—à–∏—Ç—å –≤—Å–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏
)

# –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ
logging.basicConfig(level=logging.INFO, format="%(asctime)s - %(levelname)s - %(message)s")

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
MAC_ADDRESS = "74:56:3c:96:53:39"
OWM_API_KEY = "3d79aa1b71dbdda6d891f3f04245840d"  # –í–∞—à API-–∫–ª—é—á
CITY = "Balashikha"  # –ì–æ—Ä–æ–¥ –ë–∞–ª–∞—à–∏—Ö–∞
STORAGE_PATH = "/home/tema/Files"  # –£–∫–∞–∂–∏—Ç–µ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–∞

# –ú–æ–¥–µ–ª–∏ –∑–∞–ø—Ä–æ—Å–æ–≤
class WakeOnLANRequest(BaseModel):
    mac_address: str = MAC_ADDRESS

class FileRequest(BaseModel):
    file_name: str
    action: str  # delete, download

class CreateFolderRequest(BaseModel):
    folder_name: str

# –ö–æ–º–∞–Ω–¥–∞ Wake-on-LAN
@app.post("/wol")
async def wake_on_lan(request: WakeOnLANRequest):
    try:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ª–∏ –∫–æ–º–∞–Ω–¥–∞ wakeonlan
        if not shutil.which("wakeonlan"):
            raise HTTPException(status_code=500, detail="–ö–æ–º–∞–Ω–¥–∞ wakeonlan –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞.")

        subprocess.run(['wakeonlan', request.mac_address], check=True)
        return {"status": "success", "message": "Magic Packet –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω."}
    except subprocess.CalledProcessError as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ Magic Packet: {e}")
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞: {e}")

# –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã
@app.get("/weather")
async def get_weather(city: str = CITY):
    try:
        url = f"http://api.openweathermap.org/data/2.5/forecast?q={city}&appid={OWM_API_KEY}&units=metric&lang=ru"
        response = requests.get(url)
        data = response.json()

        if response.status_code == 200:
            weather_data = data['list']
            today = datetime.now().strftime("%Y-%m-%d")
            today_weather = [w for w in weather_data if w['dt_txt'].startswith(today)]

            if today_weather:
                formatted_weather = []
                for entry in today_weather:
                    formatted_weather.append({
                        "time": entry['dt_txt'][11:16],
                        "temp": int(entry['main']['temp']),
                        "description": entry['weather'][0]['description'],
                        "humidity": entry['main']['humidity'],
                        "wind_speed": int(entry['wind']['speed']),
                        "icon": entry['weather'][0]['icon']
                    })
                return {"status": "success", "data": formatted_weather}
            else:
                return {"status": "error", "message": "–î–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç."}
        else:
            return {"status": "error", "message": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {data['message']}"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –ø–æ–≥–æ–¥—ã: {e}")

# –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
@app.get("/crypto")
async def get_crypto(coins: str = "bitcoin,ethereum,solana"):
    try:
        url = "https://api.coingecko.com/api/v3/simple/price"
        params = {
            'ids': coins,
            'vs_currencies': 'usd,rub',
            'include_market_cap': 'true',
            'include_24hr_vol': 'true',
            'include_24hr_change': 'true'
        }
        response = requests.get(url, params=params)
        data = response.json()

        if response.status_code == 200:
            crypto_data = []
            for crypto, info in data.items():
                crypto_data.append({
                    "name": crypto.capitalize(),
                    "price_usd": info['usd'],
                    "price_rub": info['rub'],
                    "change": info['usd_24h_change'],
                    "market_cap": info['usd_market_cap'],
                    "volume": info['usd_24h_vol']
                })
            return {"status": "success", "data": crypto_data}
        else:
            return {"status": "error", "message": f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö: {response.status_code}"}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∫—É—Ä—Å–æ–≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç: {e}")

# –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤ –∏ –ø–∞–ø–æ–∫
@app.get("/list-files")
async def list_files(path: str = STORAGE_PATH):
    try:
        # –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏: –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –≤—ã—Ö–æ–¥ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã –∫–æ—Ä–Ω–µ–≤–æ–π –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏
        if not os.path.abspath(path).startswith(os.path.abspath(STORAGE_PATH)):
            raise HTTPException(status_code=403, detail="–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω.")

        items = os.listdir(path)
        files = [item for item in items if os.path.isfile(os.path.join(path, item))]
        folders = [item for item in items if os.path.isdir(os.path.join(path, item))]

        return {
            "status": "success",
            "files": files,
            "folders": folders,
            "current_directory": path
        }
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤: {e}")

# –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏
@app.post("/delete-file")
async def delete_file(request: FileRequest):
    try:
        item_path = os.path.join(STORAGE_PATH, request.file_name)

        if not os.path.exists(item_path):
            return {"status": "error", "message": f"–§–∞–π–ª –∏–ª–∏ –ø–∞–ø–∫–∞ {request.file_name} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞."}

        if os.path.isfile(item_path):
            os.remove(item_path)
            return {"status": "success", "message": f"–§–∞–π–ª {request.file_name} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω."}
        else:
            shutil.rmtree(item_path)
            return {"status": "success", "message": f"–ü–∞–ø–∫–∞ {request.file_name} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞."}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: {e}")

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏
@app.post("/create-folder")
async def create_folder(request: CreateFolderRequest):
    try:
        folder_path = os.path.join(STORAGE_PATH, request.folder_name)

        if os.path.exists(folder_path):
            return {"status": "error", "message": f"–ü–∞–ø–∫–∞ {request.folder_name} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç."}

        os.makedirs(folder_path)
        return {"status": "success", "message": f"–ü–∞–ø–∫–∞ {request.folder_name} —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞."}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –ø–∞–ø–∫–∏: {e}")

# –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
@app.post("/upload-file")
async def upload_file(file: UploadFile = File(...)):
    try:
        file_path = os.path.join(STORAGE_PATH, file.filename)

        with open(file_path, "wb") as buffer:
            shutil.copyfileobj(file.file, buffer)

        return {"status": "success", "message": f"–§–∞–π–ª {file.filename} —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω."}
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞: {e}")

# –°–∫–∞—á–∏–≤–∞–Ω–∏–µ —Ñ–∞–π–ª–∞
@app.get("/download-file/{file_name}")
async def download_file(file_name: str):
    try:
        file_path = os.path.join(STORAGE_PATH, file_name)

        if not os.path.exists(file_path):
            raise HTTPException(status_code=404, detail="–§–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω.")

        return FileResponse(file_path, filename=file_name)
    except Exception as e:
        raise HTTPException(status_code=500, detail=f"–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞: {e}")

# –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞
if __name__ == "__main__":
    import uvicorn
    uvicorn.run(
        app,
        host="0.0.0.0",
        port=8000,
        ssl_keyfile="/etc/letsencrypt/live/aaero.ddns.net/privkey.pem",  # –ü—Ä–∏–≤–∞—Ç–Ω—ã–π –∫–ª—é—á
        ssl_certfile="/etc/letsencrypt/live/aaero.ddns.net/fullchain.pem"  # –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç
    )





































<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–ö –∏ —Ñ–∞–π–ª–∞–º–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
    body {
        font-family: Arial, sans-serif;
        margin: 20px;
        padding: 0;
        background-color: #f9f9f9;
    }
    h1 {
        color: #333;
        text-align: center;
    }
    button {
        padding: 10px 20px;
        margin: 5px;
        font-size: 16px;
        cursor: pointer;
        background-color: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s ease;
    }
    button:hover {
        background-color: #0056b3;
    }
    .data-list {
        margin-top: 20px;
    }
    .data-item {
        display: flex;
        align-items: center;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 10px;
        margin: 10px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .data-item i {
        font-size: 24px;
        margin-right: 10px;
        color: #007bff;
    }
    .data-item .content {
        flex-grow: 1;
    }
    .data-item .content p {
        margin: 5px 0;
        font-size: 14px;
        color: #555;
    }
    .weather-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    .current-weather {
        flex: 1;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .forecast {
        flex: 1;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .forecast h3 {
        margin-top: 0;
        color: #007bff;
    }
    .forecast-item {
        display: flex;
        justify-content: space-between;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
    }
    .forecast-item:last-child {
        border-bottom: none;
    }
    .card {
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        margin: 10px 0;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .card h3 {
        margin-top: 0;
        color: #007bff;
    }
    .card p {
        margin: 5px 0;
        font-size: 14px;
        color: #555;
    }
    .crypto-container {
        display: flex;
        gap: 20px;
        margin-top: 20px;
    }
    .crypto-info {
        flex: 1;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .crypto-details {
        flex: 1;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .crypto-details h3 {
        margin-top: 0;
        color: #007bff;
    }
    .crypto-details p {
        margin: 5px 0;
        font-size: 14px;
        color: #555;
    }
    .file-list {
        margin-top: 20px;
    }
    .file-list ul {
        list-style-type: none;
        padding: 0;
    }
    .file-list li {
        margin: 5px 0;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 10px;
        background-color: white;
        border: 1px solid #ddd;
        border-radius: 5px;
    }
    .file-list button {
        margin-left: 10px;
        background-color: #dc3545;
        color: white;
        border: none;
        border-radius: 5px;
        padding: 5px 10px;
        cursor: pointer;
    }
    .file-list button:hover {
        background-color: #c82333;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    /* –ê–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤ */
    @media (max-width: 600px) {
        h1 {
            font-size: 24px;
        }
        button {
            width: 100%;
            margin: 5px 0;
        }
        .weather-container, .crypto-container {
            flex-direction: column;
        }
        .card, .current-weather, .forecast, .crypto-info, .crypto-details {
            padding: 15px;
        }
    }
</style>
</head>
<body>
    <div class="container">
        <h1>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ü–ö –∏ —Ñ–∞–π–ª–∞–º–∏</h1>

        <button onclick="wakeOnLAN()">üñ• –í–∫–ª—é—á–∏—Ç—å –ü–ö</button>
        <button onclick="getWeather()">üå§ –ü–æ–ª—É—á–∏—Ç—å –ø–æ–≥–æ–¥—É</button>
        <button onclick="getCrypto()">üìà –ö—É—Ä—Å—ã –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç</button>
        <button onclick="listFiles()">üìÅ –°–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤</button>
        <button onclick="uploadFile()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å —Ñ–∞–π–ª</button>
        <button onclick="createFolder()">üìÇ –°–æ–∑–¥–∞—Ç—å –ø–∞–ø–∫—É</button>

        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç:</h2>
        <div id="output"></div>

        <div class="file-list">
            <h2>–§–∞–π–ª—ã –∏ –ø–∞–ø–∫–∏:</h2>
            <ul id="file-list"></ul>
        </div>
    </div>

    <script>
        // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π JavaScript-–∫–æ–¥
        const backendUrl = "https://aaero.ddns.net:8000";  // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL
        const tg = window.Telegram.WebApp;  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Telegram WebApp API
        let currentPath = "/home/tema/Files";  // –¢–µ–∫—É—â–∏–π –ø—É—Ç—å
        let pathHistory = [];  // –ò—Å—Ç–æ—Ä–∏—è –ø—É—Ç–µ–π –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ù–∞–∑–∞–¥"

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ backend
        async function sendRequest(endpoint, method = "GET", data = {}) {
            try {
                const response = await fetch(`${backendUrl}/${endpoint}`, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: method !== "GET" ? JSON.stringify(data) : null
                });

                if (!response.ok) {
                    throw new Error(`–û—à–∏–±–∫–∞: ${response.statusText}`);
                }

                return await response.json();
            } catch (error) {
                console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –∑–∞–ø—Ä–æ—Å–∞:", error);
                return { status: "error", message: error.message };
            }
        }

        // –í–∫–ª—é—á–µ–Ω–∏–µ –ü–ö (Wake-on-LAN)
        async function wakeOnLAN() {
            const result = await sendRequest('wol', 'POST', { mac_address: '74:56:3c:96:53:39' });
            const output = document.getElementById('output');
            output.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–≤–æ–¥

            if (result.status === "success") {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>üñ• Wake-on-LAN</h3>
                    <p>‚úÖ Magic Packet –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ MAC: ${result.mac_address}</p>
                `;
                output.appendChild(card);
            } else {
                output.innerText = result.message;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–≥–æ–¥—ã
        async function getWeather() {
            const result = await sendRequest('weather', 'GET');
            const output = document.getElementById('output');
            output.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–≤–æ–¥

            if (result.status === "success") {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <h3>üå§ –¢–µ–∫—É—â–∞—è –ø–æ–≥–æ–¥–∞</h3>
                    <p>üå° –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: ${result.data[0].temp}¬∞C</p>
                    <p>üå§ –ü–æ–≥–æ–¥–∞: ${result.data[0].description}</p>
                    <p>üíß –í–ª–∞–∂–Ω–æ—Å—Ç—å: ${result.data[0].humidity}%</p>
                    <p>üå¨ –í–µ—Ç–µ—Ä: ${result.data[0].wind_speed} –º/—Å</p>
                `;
                output.appendChild(card);
            } else {
                output.innerText = result.message;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –∫—Ä–∏–ø—Ç–æ–≤–∞–ª—é—Ç
        async function getCrypto() {
            const result = await sendRequest('crypto', 'GET');
            const output = document.getElementById('output');
            output.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–≤–æ–¥

            if (result.status === "success") {
                result.data.forEach(crypto => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>üí∞ ${crypto.name}</h3>
                        <p>üí∞ USD: $${crypto.price_usd.toFixed(2)}</p>
                        <p>‚ÇΩ RUB: ‚ÇΩ${crypto.price_rub.toFixed(2)}</p>
                        <p>üìà –ò–∑–º–µ–Ω–µ–Ω–∏–µ: ${crypto.change.toFixed(2)}%</p>
                        <p>üíº –ö–∞–ø–∏—Ç–∞–ª: $${(crypto.market_cap / 1e9).toFixed(2)}B</p>
                        <p>üìä –û–±—ä–µ–º: $${(crypto.volume / 1e9).toFixed(2)}B</p>
                    `;
                    output.appendChild(card);
                });
            } else {
                output.innerText = result.message;
            }
        }

        // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ñ–∞–π–ª–æ–≤
        async function listFiles(path = currentPath) {
            const result = await sendRequest('list-files', 'GET', { path });
            const fileList = document.getElementById('file-list');
            output.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–≤–æ–¥
            fileList.innerHTML = "";

            if (result.status === "success") {
                currentPath = result.current_directory;
                pathHistory.push(currentPath);  // –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é

                // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ù–∞–∑–∞–¥", –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –∫–æ—Ä–Ω–µ–≤–æ–π –∫–∞—Ç–∞–ª–æ–≥
                if (pathHistory.length > 1) {
                    const backButton = document.createElement('button');
                    backButton.innerText = "‚¨ÖÔ∏è –ù–∞–∑–∞–¥";
                    backButton.onclick = () => {
                        pathHistory.pop();  // –£–¥–∞–ª—è–µ–º —Ç–µ–∫—É—â–∏–π –ø—É—Ç—å –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏
                        const previousPath = pathHistory[pathHistory.length - 1];
                        listFiles(previousPath);
                    };
                    fileList.appendChild(backButton);
                }

                result.files.forEach(file => {
                    const li = document.createElement('li');
                    li.innerText = `üìÑ ${file}`;

                    const deleteButton = document.createElement('button');
                    deleteButton.innerText = "üóë –£–¥–∞–ª–∏—Ç—å";
                    deleteButton.onclick = () => deleteFileOrFolder(file, 'file');

                    li.appendChild(deleteButton);
                    fileList.appendChild(li);
                });

                result.folders.forEach(folder => {
                    const li = document.createElement('li');
                    li.innerText = `üìÅ ${folder}`;

                    const openButton = document.createElement('button');
                    openButton.innerText = "üìÇ –û—Ç–∫—Ä—ã—Ç—å";
                    openButton.onclick = () => listFiles(`${currentPath}/${folder}`);

                    const deleteButton = document.createElement('button');
                    deleteButton.innerText = "üóë –£–¥–∞–ª–∏—Ç—å";
                    deleteButton.onclick = () => deleteFileOrFolder(folder, 'folder');

                    li.appendChild(openButton);
                    li.appendChild(deleteButton);
                    fileList.appendChild(li);
                });
            } else {
                document.getElementById('output').innerText = JSON.stringify(result, null, 2);
            }
        }

        // –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞ –∏–ª–∏ –ø–∞–ø–∫–∏
        async function deleteFileOrFolder(name, type) {
            const confirmDelete = confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${type === 'file' ? '—Ñ–∞–π–ª' : '–ø–∞–ø–∫—É'} "${name}"?`);
            if (confirmDelete) {
                const result = await sendRequest('delete-file', 'POST', { file_name: name, action: 'delete' });
                const output = document.getElementById('output');
                output.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–≤–æ–¥

                if (result.status === "success") {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>${type === 'file' ? 'üóë –£–¥–∞–ª–µ–Ω–∏–µ —Ñ–∞–π–ª–∞' : 'üóë –£–¥–∞–ª–µ–Ω–∏–µ –ø–∞–ø–∫–∏'}</h3>
                        <p>‚úÖ ${type === 'file' ? '–§–∞–π–ª' : '–ü–∞–ø–∫–∞'} "${name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω(–∞).</p>
                    `;
                    output.appendChild(card);
                } else {
                    output.innerText = result.message;
                }
                listFiles();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
            } else {
                document.getElementById('output').innerText = "–£–¥–∞–ª–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ.";
            }
        }

        // –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏
        async function createFolder() {
            const folderName = prompt("–í–≤–µ–¥–∏—Ç–µ –∏–º—è –Ω–æ–≤–æ–π –ø–∞–ø–∫–∏:");
            if (folderName) {
                const result = await sendRequest('create-folder', 'POST', { folder_name: folderName });
                const output = document.getElementById('output');
                output.innerHTML = "";  // –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π –≤—ã–≤–æ–¥

                if (result.status === "success") {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>üìÇ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–ø–∫–∏</h3>
                        <p>‚úÖ –ü–∞–ø–∫–∞ "${folderName}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞.</p>
                    `;
                    output.appendChild(card);
                } else {
                    output.innerText = result.message;
                }
                listFiles();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
            }
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞
        async function uploadFile() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.onchange = async (event) => {
                const file = event.target.files[0];
                const formData = new FormData();
                formData.append('file', file);

                try {
                    const response = await fetch(`${backendUrl}/upload-file`, {
                        method: 'POST',
                        body: formData
                    });
                    const result = await response.json();
                    document.getElementById('output').innerText = JSON.stringify(result, null, 2);
                    listFiles();  // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ñ–∞–π–ª–æ–≤
                } catch (error) {
                    console.error("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞:", error);
                    document.getElementById('output').innerText = "–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞.";
                }
            };
            fileInput.click();
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Mini App Telegram
        tg.ready();  // –£–≤–µ–¥–æ–º–ª—è–µ–º Telegram, —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
    </script>
</body>
</html>
